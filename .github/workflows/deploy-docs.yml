# .github/workflows/deploy-docs.yml

name: Build and Test Qanto Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'qanto-docs/**'
      - '.github/workflows/deploy-docs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'qanto-docs/**'
  workflow_dispatch:

# Allow only one concurrent build for the same branch/PR
concurrency:
  group: "docs-build-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  build:
    name: Build and Test Docs
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for git history for lastmod dates
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: qanto-docs/package-lock.json
      
      - name: Install documentation dependencies
        working-directory: ./qanto-docs
        run: npm ci
      
      - name: Build Docusaurus site
        working-directory: ./qanto-docs
        run: npm run build
      
      - name: Install HTML Proofer
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby-full
          sudo gem install html-proofer
          
      - name: Validate build output
        working-directory: ./qanto-docs
        run: htmlproofer ./build --url-ignore "/assets/" --http-status-ignore "403,429"
        
  # This job comments on the PR with the build status and a preview link
  comment-on-pr:
    if: github.event_name == 'pull_request'
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      
    steps:
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const pr_user = context.payload.pull_request.user.login;
            
            // Find a previous comment by the bot
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
            });
            const botComment = comments.find(comment => comment.user.login === 'github-actions[bot]');

            const body = `ðŸ‘‹ @${pr_user}, the documentation build has completed successfully.
            
            - **Status**: Success
            - **Preview**: [https://qanto.org/docs](https://qanto.org/docs) (Note: Preview link is not yet available)
            
            The build artifact is ready for review and deployment.`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # This job sends a notification on a successful build to main
  notify-build:
    if: success() && github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#infrastructure'
          author_name: 'GitHub Actions'
          title: 'Qanto Docs Build Succeeded'
          message: |
            Documentation build for the \`main\` branch completed successfully.
            - **Commit**: <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha.slice(0,7) }}>
            - **Author**: ${{ github.actor }}
            The build artifacts are ready for deployment.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
